<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒ∞sim Zinciri - Joker & Ses</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 450px; height: 100vh; background-color: #e5ddd5; display: flex; flex-direction: column; position: relative; }
        
        #lobby { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: #075e54; color: white; text-align: center; z-index: 20; position: absolute; width: 100%; height: 100%; }
        #lobby input, #lobby select { padding: 15px; border-radius: 25px; border: none; font-size: 1.1rem; margin: 10px 0; width: 85%; text-align: center; outline: none; text-transform: uppercase; font-weight: bold;}
        #lobby button { margin-top: 15px; padding: 15px 30px; border-radius: 25px; border: none; background: #25d366; color: white; font-size: 1.2rem; cursor: pointer; font-weight: bold; width: 85%; }
        
        .header { background-color: #075e54; color: white; padding: 10px 15px; display: flex; flex-direction: column; align-items: center; }
        .scoreboard { display: flex; justify-content: space-between; width: 100%; font-size: 1.1rem; margin-bottom: 5px; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 15px;}
        .score-box { font-weight: bold; }
        .score-box.me { color: #25d366; }
        .score-box.opp { color: #ffffff; }
        .turn-indicator { font-size: 1rem; font-weight: bold; margin-top: 5px; }
        
        .timer-track { background-color: #ddd; height: 8px; width: 100%; }
        .timer-bar { background-color: #25d366; height: 100%; width: 100%; transition: width 1s linear, background-color 0.3s; }
        .chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; }
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 1.1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: bold; position: relative;}
        .bubble span { font-size: 0.8rem; opacity: 0.7; display: block; margin-bottom: 3px; font-weight: normal;}
        .bubble .points { font-size: 0.8rem; color: #d32f2f; float: right; margin-left: 10px; font-weight: bold;}
        .my-msg { background-color: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 0; }
        .opp-msg { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 0; }
        .system { background-color: rgba(0,0,0,0.6); color: white; align-self: center; font-size: 0.9rem; border-radius: 15px; padding: 5px 15px; text-align: center; }
        .system-joker { background-color: #ff9800; color: white; align-self: center; font-size: 0.9rem; border-radius: 15px; padding: 5px 15px; text-align: center; font-weight: bold;}
        
        .joker-area { display: flex; justify-content: space-around; background: #e5ddd5; padding: 5px; border-top: 1px solid #ccc;}
        .joker-btn { padding: 8px; border-radius: 10px; border: none; background: #3498db; color: white; font-weight: bold; cursor: pointer; flex: 1; margin: 0 5px; transition: 0.2s; text-align: center;}
        .joker-btn:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.8;}
        
        .input-area { background-color: #f0f0f0; padding: 10px; display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 12px 15px; border-radius: 25px; border: none; font-size: 1rem; outline: none; text-transform: uppercase; }
        .input-area button { background-color: #075e54; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
        
        #gameOverScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 30; }
        #gameOverScreen h2 { font-size: 2.5rem; margin-bottom: 10px;}
        .final-scores { margin: 20px 0; font-size: 1.3rem; background: #333; padding: 15px; border-radius: 15px;}
        #gameOverScreen button { margin-top: 10px; padding: 10px 30px; background: #25d366; border: none; border-radius: 25px; color: white; font-size: 1.2rem; cursor: pointer; }
        #playAgainStatus { display:none; color: #ffeb3b; margin-top: 10px; font-weight: bold; font-size: 1.1rem;}
    </style>
</head>
<body>

<div class="app-container">
    <div id="lobby">
        <h1>ƒ∞sim Zinciri üîó</h1>
        <input type="text" id="usernameInput" placeholder="KULLANICI ADIN">
        <input type="text" id="roomInput" placeholder="ODA KODU">
        <select id="gameModeInput">
            <option value="classic">Klasik Mod (Son Harf)</option>
            <option value="random">Rastgele Harf Modu</option>
        </select>
        <button onclick="joinRoom()">ODAYA KATIL</button>
    </div>

    <div class="header">
        <div class="scoreboard">
            <div class="score-box me" id="myScoreText">Sen: 0</div>
            <div class="score-box opp" id="oppScoreText">Rakip: 0</div>
        </div>
        <div class="turn-indicator" id="turnText">Bekleniyor...</div>
    </div>
    
    <div class="timer-track"><div class="timer-bar" id="timerBar"></div></div>
    <div class="chat-box" id="chatBox"></div>
    
    <div class="joker-area">
        <button class="joker-btn" id="btnFreeze" onclick="sendJoker('freeze')" disabled>‚ùÑÔ∏è Buz</button>
        <button class="joker-btn" id="btnLetter" onclick="sendJoker('letter')" disabled>üî§ Harf</button>
        <button class="joker-btn" id="btnPass" onclick="sendJoker('pass')" disabled>‚è≠Ô∏è Pas</button>
    </div>

    <div class="input-area">
        <input type="text" id="nameInput" placeholder="ƒ∞sim yaz..." disabled>
        <button id="sendBtn" disabled>‚ñ∂</button>
    </div>

    <div id="gameOverScreen">
        <h2 id="winnerTitle">Oyun Bitti!</h2>
        <p id="gameOverReason"></p>
        <div class="final-scores" id="finalScoresDiv"></div>
        <button id="playAgainBtn" onclick="requestPlayAgain()">Tekrar Oyna</button>
        <p id="playAgainStatus">Rakibin onayƒ± bekleniyor...</p>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myId = '', currentRoom = '', isMyTurn = false, myName = '';
    const timeLimit = 10;
    let timeLeft = timeLimit, timerInterval;
    let cooldownIntervals = { freeze: null, letter: null, pass: null };

    let audioCtx;
    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playTick() {
        if (!audioCtx || !isMyTurn) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'sine'; 
        osc.frequency.setValueAtTime(timeLeft <= 3 ? 800 : 400, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function joinRoom() {
        initAudio(); 
        myName = document.getElementById('usernameInput').value.trim();
        const code = document.getElementById('roomInput').value.trim().toUpperCase();
        const mode = document.getElementById('gameModeInput').value;
        if(!myName || !code) return alert("Eksik bilgi girdiniz!");
        currentRoom = code;
        socket.emit('joinRoom', { roomCode: code, username: myName, mode: mode });
    }

    socket.on('connect', () => myId = socket.id);
    socket.on('joined', (data) => {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('myScoreText').innerText = `${myName}: 0`;
        if(data.playerNumber === 1) addMsg("Oda kuruldu. Rakip bekleniyor...", "system");
    });

    socket.on('gameStart', (data) => {
        document.getElementById('gameOverScreen').style.display = 'none';
        document.getElementById('playAgainBtn').style.display = 'inline-block';
        document.getElementById('playAgainStatus').style.display = 'none';
        document.getElementById('chatBox').innerHTML = '';
        
        document.getElementById('myScoreText').innerText = `${myName}: 0`;
        const opp = data.players.find(p => p.id !== myId);
        if(opp) document.getElementById('oppScoreText').innerText = `${opp.name}: 0`;

        // Jokerleri ve Cooldown'larƒ± Sƒ±fƒ±rla
        ['freeze', 'letter', 'pass'].forEach(type => {
            clearInterval(cooldownIntervals[type]);
            cooldownIntervals[type] = null;
            let btnId = type === 'freeze' ? 'btnFreeze' : type === 'letter' ? 'btnLetter' : 'btnPass';
            document.getElementById(btnId).innerText = type === 'freeze' ? '‚ùÑÔ∏è Buz' : type === 'letter' ? 'üî§ Harf' : '‚è≠Ô∏è Pas';
        });

        const modName = data.mode === 'random' ? "Rastgele Harf Modu" : "Klasik Mod";
        addMsg(`Oyun Ba≈üladƒ±! (${modName})`, "system");
        addMsg(data.firstWord, 'system');
        handleTurn(data.players[data.turnIndex].id, data.currentLetter, data.players[data.turnIndex].name);
    });

    socket.on('moveMade', (data) => {
        document.getElementById(data.playerId === myId ? 'myScoreText' : 'oppScoreText').innerText = `${data.playerName}: ${data.players.find(p=>p.id===data.playerId).score}`;
        addMsg(data.word, data.playerId === myId ? 'my-msg' : 'opp-msg', data.playerName, data.pointsEarned);
        handleTurn(data.players[data.nextTurnIndex].id, data.nextLetter, data.players[data.nextTurnIndex].name);
    });

    function sendJoker(type) {
        if(!isMyTurn || cooldownIntervals[type] !== null) return;
        socket.emit('useJoker', { roomCode: currentRoom, type: type });
    }

    // COOLDOWN (30s) G√ñRSEL Sƒ∞STEMƒ∞
    function startCooldown(type) {
        let btnId = type === 'freeze' ? 'btnFreeze' : type === 'letter' ? 'btnLetter' : 'btnPass';
        let btn = document.getElementById(btnId);
        let originalText = type === 'freeze' ? '‚ùÑÔ∏è Buz' : type === 'letter' ? 'üî§ Harf' : '‚è≠Ô∏è Pas';
        
        btn.disabled = true;
        let secondsLeft = 30;
        btn.innerText = secondsLeft + "s";
        
        clearInterval(cooldownIntervals[type]);
        cooldownIntervals[type] = setInterval(() => {
            secondsLeft--;
            if (secondsLeft <= 0) {
                clearInterval(cooldownIntervals[type]);
                cooldownIntervals[type] = null;
                btn.innerText = originalText;
                if(isMyTurn) btn.disabled = false; // Sƒ±ra bendeyse tekrar aktifle≈ütir
            } else {
                btn.innerText = secondsLeft + "s";
            }
        }, 1000);
    }

    socket.on('jokerEffect', (data) => {
        if (data.playerId === myId) startCooldown(data.type); // Sadece kullanan ki≈üinin ekranƒ±nda 30s ba≈ülar

        if(data.type === 'freeze') {
            addMsg(`‚ùÑÔ∏è ${data.playerName} s√ºresini sƒ±fƒ±rladƒ±!`, "system-joker");
            if(isMyTurn) startTimer(); 
        } 
        else if(data.type === 'letter') {
            addMsg(`üî§ ${data.playerName} harf deƒüi≈ütirdi! Yeni harf: ${data.letter}`, "system-joker");
            document.getElementById('turnText').innerText = `Sƒ±ra Sende! (${data.letter} ile ba≈üla)`;
        } 
        else if(data.type === 'pass') {
            addMsg(`‚è≠Ô∏è ${data.playerName} pas ge√ßti!`, "system-joker");
            const isMeNow = myName !== data.playerName;
            handleTurn(isMeNow ? myId : 'opp', data.letter, isMeNow ? myName : 'Rakip');
        }
    });

    // TEKRAR OYNA ƒ∞STEƒûƒ∞ (Onay Sistemi)
    function requestPlayAgain() {
        socket.emit('playAgainVote', currentRoom);
        document.getElementById('playAgainBtn').style.display = 'none';
        document.getElementById('playAgainStatus').style.display = 'block';
    }

    socket.on('opponentVotedPlayAgain', () => {
        addMsg("Rakibin tekrar oynamak istiyor! Kabul etmek i√ßin Tekrar Oyna'ya bas.", "system-joker");
    });

    socket.on('errorMsg', msg => alert(msg));
    socket.on('gameOver', data => {
        clearInterval(timerInterval);
        document.getElementById('gameOverScreen').style.display = 'flex';
        document.getElementById('gameOverReason').innerText = data.reason;
        
        if (data.reason === 'Rakip oyundan √ßƒ±ktƒ±!') {
            document.getElementById('playAgainBtn').setAttribute('onclick', 'location.reload()');
            document.getElementById('playAgainBtn').innerText = "Lobiye D√∂n";
        } else {
            document.getElementById('playAgainBtn').setAttribute('onclick', 'requestPlayAgain()');
            document.getElementById('playAgainBtn').innerText = "Tekrar Oyna";
        }

        document.getElementById('winnerTitle').innerText = data.loserId === myId ? "Elendin! üò¢" : "Kazandƒ±n! üèÜ";
        document.getElementById('winnerTitle').style.color = data.loserId === myId ? "#ff5252" : "#25d366";
        document.getElementById('finalScoresDiv').innerHTML = `${data.players[0].name}: ${data.players[0].score} Puan <br> ${data.players[1].name}: ${data.players[1].score} Puan`;
    });

    function handleTurn(activeId, letter, activeName) {
        clearInterval(timerInterval);
        isMyTurn = activeId === myId;
        const turnText = document.getElementById('turnText');
        const input = document.getElementById('nameInput');
        const btn = document.getElementById('sendBtn');
        
        // Sadece sƒ±ra sendeyse ve 30 saniye cooldown dolmu≈üsa butonlarƒ± aktif et
        document.querySelectorAll('.joker-btn').forEach(b => {
            const type = b.id === 'btnFreeze' ? 'freeze' : b.id === 'btnLetter' ? 'letter' : 'pass';
            b.disabled = !isMyTurn || cooldownIntervals[type] !== null;
        });

        if (isMyTurn) {
            turnText.innerText = `Sƒ±ra Sende! (${letter} ile ba≈üla)`; turnText.style.color = "#25d366";
            input.disabled = false; btn.disabled = false; input.focus();
            startTimer();
        } else {
            turnText.innerText = `Sƒ±ra ${activeName}'da...`; turnText.style.color = "#ffeb3b";
            input.disabled = true; btn.disabled = true; input.value = "";
            document.getElementById('timerBar').style.width = "100%"; document.getElementById('timerBar').style.backgroundColor = "#ddd";
        }
    }

    function startTimer() {
        clearInterval(timerInterval); // ƒ∞≈üte gizli kronometreyi (bug'ƒ±) yok eden satƒ±r!
        timeLeft = timeLimit;
        updateTimerUI();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerUI();
            playTick(); 
            if(timeLeft <= 0) { clearInterval(timerInterval); socket.emit('timeUp', currentRoom); }
        }, 1000);
    }

    function updateTimerUI() {
        const pct = (timeLeft / timeLimit) * 100;
        const bar = document.getElementById('timerBar');
        bar.style.width = pct + '%';
        bar.style.backgroundColor = pct > 50 ? '#25d366' : pct > 25 ? '#ffeb3b' : '#ff5252';
    }

    document.getElementById('sendBtn').onclick = () => {
        if(!isMyTurn) return;
        const word = document.getElementById('nameInput').value.trim();
        if(word) { socket.emit('makeMove', { roomCode: currentRoom, word }); document.getElementById('nameInput').value = ''; }
    };
    document.getElementById('nameInput').addEventListener('keypress', e => { if(e.key === 'Enter') document.getElementById('sendBtn').click(); });

    function addMsg(text, type, senderName = '', points = 0) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `bubble ${type}`;
        div.innerHTML = (senderName && !type.includes('system') ? `<span>${senderName}</span>` : '') + text + (points > 0 ? `<span class="points">+${points}</span>` : '');
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }
</script>

</body>
</html>
